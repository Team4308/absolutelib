name: Deploy Pages Maven Repo

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3

      - name: Derive version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="main-SNAPSHOT-${SHORT_SHA}"
          fi
          echo "PUBLISH_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Publish to local Pages repo
        run: ./gradlew -Pversion="${PUBLISH_VERSION}" -PpagesPublish publishPagesRepo --no-daemon

      - name: Verify local Maven repo contents
        run: |
          echo "Listing build/pages-maven:"
          find build/pages-maven -type f | head -50 || true

      - name: Prepare deploy directory
        run: |
          mkdir -p deploy/releases
          rsync -a build/pages-maven/ deploy/releases/
          cp absolutelib.json deploy/releases/absolutelib.json
          cp absolutelib.json deploy/absolutelib.json
          echo "<html><body><h1>AbsoluteLib Releases</h1></body></html>" > deploy/index.html
          touch deploy/.nojekyll

      - name: Check artifact availability (non-fatal)
        run: |
          POM_URL="https://team4308.github.io/absolutelib/releases/ca/team4308/absolutelib-java/${PUBLISH_VERSION}/absolutelib-java-${PUBLISH_VERSION}.pom"
          echo "Checking $POM_URL"
          curl -I $POM_URL || echo "POM not reachable yet."

      - name: Assert POM exists
        run: |
          LOCAL_POM="build/pages-maven/ca/team4308/absolutelib-java/${PUBLISH_VERSION}/absolutelib-java-${PUBLISH_VERSION}.pom"
          if [ ! -f "$LOCAL_POM" ]; then
            echo "Expected POM not found locally: $LOCAL_POM"
            echo "If this was a non-tag push, version is a snapshot (main-SNAPSHOT-<sha>)."
            exit 1
          fi

      - name: Upload local Maven dir (debug)
        uses: actions/upload-artifact@v4
        with:
          name: pages-maven-${{ env.PUBLISH_VERSION }}
          path: build/pages-maven

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
