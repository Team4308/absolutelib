name: Deploy Pages Maven Repo
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3

      - name: Derive version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="main-SNAPSHOT-${SHORT_SHA}"
          fi
          echo "PUBLISH_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Publish to local Pages repo
        run: ./gradlew -Pversion="${PUBLISH_VERSION}" -PpagesPublish publishPagesRepo --no-daemon

      - name: Prepare deploy directory
        run: |
          mkdir -p deploy/releases
          rsync -a build/pages-maven/ deploy/releases/
          echo "<html><body><h1>AbsoluteLib Releases</h1></body></html>" > deploy/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
