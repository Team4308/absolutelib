name: Deploy Pages Maven Repo

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Only use the protected 'github-pages' environment when running from main,
    # so tags don't try to deploy directly and get blocked.
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    # Skip the deploy steps entirely when the ref is a tag (v*).
    if: startsWith(github.ref, 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Derive version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="main-SNAPSHOT-${SHORT_SHA}"
          fi
          echo "PUBLISH_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Publish to local Pages repo
        run: ./gradlew -Pversion="${PUBLISH_VERSION}" -PpagesPublish publishPagesRepo --no-daemon

      - name: Verify local Maven repo contents
        run: |
          echo "Listing build/pages-maven:"
          find build/pages-maven -type f | head -50 || true

      - name: Prepare deploy directory
        run: |
          mkdir -p deploy/releases
          # Copy Maven repo under /releases so it is a full Maven repository
          cp -R build/pages-maven/* deploy/releases/
          # Vendor JSON at root and under /releases for convenience
          cp absolutelib.json deploy/releases/absolutelib.json
          cp absolutelib.json deploy/absolutelib.json
          echo "<html><body><h1>AbsoluteLib Releases Root</h1><p>Vendor JSON at /absolutelib.json</p></body></html>" > deploy/index.html
          echo "<html><body><h1>AbsoluteLib Maven Releases</h1><p>Maven repo at /releases/</p></body></html>" > deploy/releases/index.html
          echo "<html><body><h2>404 - Not Found</h2></body></html>" > deploy/404.html
          touch deploy/.nojekyll

      - name: List deploy structure
        run: |
          echo "Deploy tree (first 100 entries):"
          find deploy -type f | head -100

      - name: Upload local Maven dir (debug)
        uses: actions/upload-artifact@v4
        with:
          name: pages-maven-${{ env.PUBLISH_VERSION }}
          path: build/pages-maven

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
