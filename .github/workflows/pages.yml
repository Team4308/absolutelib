name: Deploy Pages Maven Repo

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Only use the protected 'github-pages' environment when running from main,
    # so tags don't try to deploy directly and get blocked.
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    # Skip the deploy steps entirely when the ref is a tag (v*).
    if: startsWith(github.ref, 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Derive version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="main-SNAPSHOT-${SHORT_SHA}"
          fi
          echo "PUBLISH_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Publish to local Pages repo
        run: ./gradlew "-Pversion=${PUBLISH_VERSION}" "-PpagesPublish=true" publishPagesRepo --no-daemon

      - name: List built Maven repo
        run: |
          echo "Listing build/pages-maven:"
          find build/pages-maven -type f | head -100 || true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/pages-maven

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
